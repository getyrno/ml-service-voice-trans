<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Voice Recognition</title>

  <style>
    :root { color-scheme: light; }
    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 24px 16px;
      min-height: 100vh;
      background:
        radial-gradient(circle at top left, #e8ecff 0, transparent 55%),
        radial-gradient(circle at bottom right, #ffe9f0 0, transparent 55%),
        #f5f5f7;
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "SF Pro Text",
                   "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .container {
      width: 100%;
      max-width: 720px;
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(26px);
      -webkit-backdrop-filter: blur(26px);
      padding: 28px 22px 26px;
      border-radius: 24px;
      box-shadow:
        0 24px 45px rgba(0, 0, 0, 0.14),
        0 0 0 0.5px rgba(0, 0, 0, 0.04);
      animation: fadeIn 0.25s ease-out;
    }

    @media (min-width: 768px) {
      .container { padding: 32px 32px 30px; border-radius: 26px; }
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px) scale(0.99); }
      to   { opacity: 1; transform: translateY(0) scale(1); }
    }

    header { text-align: left; margin-bottom: 22px; }

    header h1 {
      margin: 0 0 4px;
      font-weight: 650;
      color: #1d1d1f;
      letter-spacing: -0.4px;
      font-size: 1.7rem;
    }

    header p { margin: 0; color: #6e6e73; font-size: 0.95rem; }

    @media (min-width: 768px) {
      header h1 { font-size: 1.9rem; }
      header p  { font-size: 1rem; }
    }

    .card {
      background: #fbfbfd;
      border-radius: 18px;
      border: 1px solid #e5e5ea;
      padding: 16px 16px 18px;
    }

    @media (min-width: 768px) {
      .card { padding: 18px 20px 20px; display: flex; gap: 16px; align-items: center; }
    }

    .file-area { flex: 1; }

    .file-label {
      display: block;
      margin-bottom: 6px;
      font-size: 0.9rem;
      font-weight: 500;
      color: #3a3a3c;
    }

    .file-hint { margin-top: 6px; font-size: 0.8rem; color: #8e8e93; }
    .file-hint strong { font-weight: 600; color: #1d1d1f; }

    input[type="file"] {
      width: 100%;
      padding: 10px 11px;
      background: #ffffff;
      border: 1px solid #d2d2d7;
      border-radius: 12px;
      font-size: 0.9rem;
      cursor: pointer;
      transition: 0.2s;
    }

    input[type="file"]:hover { background: #f4f4f6; border-color: #b7b7c4; }

    .file-info {
      margin-top: 10px;
      padding: 10px 11px;
      border-radius: 11px;
      background: #f5f5f7;
      border: 1px solid transparent;
      font-size: 0.85rem;
    }

    .file-info.empty { opacity: 0.7; }
    .file-info.file-error { border-color: #ff3b30; background: #fff5f5; }

    .file-name {
      font-weight: 500;
      color: #1d1d1f;
      margin-bottom: 3px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .file-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      color: #8e8e93;
    }

    .file-meta span { display: inline-flex; align-items: center; gap: 4px; }

    .dot { width: 4px; height: 4px; border-radius: 50%; background: #c7c7cc; }

    .actions { margin-top: 14px; }
    @media (min-width: 768px) {
      .actions { margin-top: 0; width: 210px; text-align: right; }
    }

    button {
      width: 100%;
      padding: 12px 14px;
      font-size: 0.95rem;
      border: none;
      border-radius: 999px;
      cursor: pointer;
      font-weight: 600;
      color: #ffffff;
      background: linear-gradient(135deg, #0071e3, #0f8fff);
      box-shadow: 0 8px 16px rgba(0, 122, 255, 0.35);
      transition: background 0.2s ease, box-shadow 0.17s ease, transform 0.12s ease;
    }

    button:hover:not(:disabled) {
      background: linear-gradient(135deg, #007aff, #2f9bff);
      box-shadow: 0 11px 20px rgba(0, 122, 255, 0.45);
    }

    button:active:not(:disabled) {
      transform: translateY(1px) scale(0.99);
      box-shadow: 0 5px 12px rgba(0, 122, 255, 0.25);
    }

    button:disabled { background: #c7c7cc; box-shadow: none; cursor: default; }

    .loader-wrap {
      margin-top: 18px;
      display: flex;
      align-items: center;
      gap: 10px;
      min-height: 24px;
      font-size: 0.85rem;
      color: #8e8e93;
    }

    #spinner {
      display: none;
      width: 22px;
      height: 22px;
      border-radius: 50%;
      border: 3px solid rgba(0, 0, 0, 0.07);
      border-top-color: #007aff;
      animation: spin 0.7s linear infinite;
    }

    @keyframes spin { 100% { transform: rotate(360deg); } }

    .section {
      margin-top: 20px;
      padding: 18px 16px 17px;
      background: #ffffff;
      border-radius: 16px;
      border: 1px solid #e5e5ea;
    }

    @media (min-width: 768px) { .section { padding: 20px 20px 18px; } }

    .section h3 {
      margin: 0 0 10px;
      font-weight: 600;
      color: #1d1d1f;
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.98rem;
    }

    .section h3 span { font-size: 1.1rem; }

    .metric-table { width: 100%; border-collapse: collapse; margin-top: 8px; font-size: 0.9rem; }
    .metric-table td { padding: 7px 0; border-bottom: 1px solid #f1f1f3; vertical-align: top; }
    .metric-table tr:last-child td { border-bottom: none; }

    .metric-label { font-weight: 600; color: #3a3a3c; }

    pre {
      margin: 0;
      white-space: pre-wrap;
      word-wrap: break-word;
      background: #f5f5f7;
      padding: 12px 12px;
      border-radius: 12px;
      font-size: 0.9rem;
      line-height: 1.45;
      max-height: 320px;
      overflow: auto;
    }

    @media (min-width: 768px) { pre { max-height: 420px; } }

    @media (max-width: 360px) {
      header h1 { font-size: 1.4rem; }
      .container { padding: 20px 16px 18px; }
    }

    /* ===== JOB UI ===== */
    .job-badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 12px;
      border-radius:999px;
      font-weight:600;
      font-size:0.9rem;
      border:1px solid #e5e5ea;
      background:#fff;
      color:#1d1d1f;
    }
    .job-idle{ background:#f5f5f7; }
    .job-queued{ background:#fff7e6; border-color:#ffd59a; }
    .job-processing{ background:#e9f2ff; border-color:#bcd7ff; }
    .job-done{ background:#eaf7ee; border-color:#bfe6c9; }
    .job-error{ background:#fff5f5; border-color:#ffb3b3; color:#b42318; }

    .progress{
      width:100%;
      height:10px;
      border-radius:999px;
      background:#f1f1f3;
      overflow:hidden;
      border:1px solid #e5e5ea;
    }
    .progress-bar{
      height:100%;
      border-radius:999px;
      background:linear-gradient(135deg, #0071e3, #0f8fff);
      transition:width 0.25s ease;
    }

    .copy-btn{
      padding:6px 10px;
      border-radius:999px;
      border:1px solid #d2d2d7;
      background:#fff;
      cursor:pointer;
      font-weight:600;
      font-size:0.8rem;
    }
    .copy-btn:hover{ background:#f4f4f6; }

    details > summary {
      list-style: none;
      cursor: pointer;
      user-select: none;
      color: #0071e3;
      font-weight: 650;
      padding: 6px 0;
      outline: none;
    }
    details > summary::-webkit-details-marker { display: none; }
    .subtle { color:#6e6e73; font-size:0.9rem; }
    .pill {
      display:inline-flex; align-items:center; gap:6px;
      padding:4px 10px; border-radius:999px;
      border:1px solid #e5e5ea; background:#fbfbfd;
      font-size:0.85rem; font-weight:600; color:#1d1d1f;
    }
    .click-row { cursor:pointer; }
    .click-row:hover td { background: #fbfbfd; }
  </style>
</head>

<body>
<div class="container">
  <header>
    <h1>Voice Recognition</h1>
    <p>–ó–∞–≥—Ä—É–∑–∏—Ç–µ –≤–∏–¥–µ–æ—Ñ–∞–π–ª, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –±—ã—Å—Ç—Ä—ã–π –∏ —Ç–æ—á–Ω—ã–π —Ç–µ–∫—Å—Ç.</p>
  </header>

  <div class="card">
    <div class="file-area">
      <label class="file-label" for="videoFile">–í–∏–¥–µ–æ –¥–ª—è —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏–∏</label>
      <input type="file" id="videoFile" accept="video/*" />

      <div id="fileInfo" class="file-info empty">
        <div id="fileName" class="file-name">–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω</div>
        <div class="file-meta">
          <span id="fileSize">–†–∞–∑–º–µ—Ä: ‚Äî</span>
          <span class="dot"></span>
          <span id="fileDuration">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: ‚Äî</span>
        </div>
      </div>

      <div class="file-hint">
        –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ ‚Äî <strong>1000&nbsp;–ú–ë</strong>.
        –î–ª—è –Ω–∞–∏–ª—É—á—à–µ–≥–æ –∫–∞—á–µ—Å—Ç–≤–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤–∏–¥–µ–æ —Å —á—ë—Ç–∫–∏–º –∑–≤—É–∫–æ–º.
      </div>
    </div>

    <div class="actions">
      <button id="uploadButton">–¢—Ä–∞–Ω—Å–∫—Ä–∏–±–∏—Ä–æ–≤–∞—Ç—å</button>
    </div>
  </div>

  <div class="loader-wrap">
    <div id="spinner"></div>
    <div id="loaderText" style="display:none;">–ò–¥—ë—Ç —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏—è‚Ä¶</div>
  </div>

  <div id="jobStatusPanel" class="section" style="display:none;">
    <h3><span>‚è±Ô∏è</span> –°—Ç–∞—Ç—É—Å –∑–∞–¥–∞—á–∏</h3>

    <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
      <div id="jobBadge" class="job-badge job-idle">‚Äî</div>
      <div class="subtle">
        Job: <span id="jobIdText">‚Äî</span>
        <!-- <button id="copyJobIdBtn" class="copy-btn" type="button" style="margin-left:8px; display:none;">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button> -->
      </div>
    </div>

    <div class="progress" style="margin-top:12px;">
      <div id="jobProgressBar" class="progress-bar" style="width:0%"></div>
    </div>
    <div id="jobStageText" class="subtle" style="margin-top:8px;">‚Äî</div>
  </div>

  <div id="jobHistoryPanel" class="section" style="display:none;">
    <h3><span>üßæ</span> –ò—Å—Ç–æ—Ä–∏—è –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>

    <details id="jobHistoryDetails">
      <summary>–ü–æ–∫–∞–∑–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é —ç—Ç–∞–ø–æ–≤</summary>
      <div style="margin-top:12px; overflow:auto;">
        <table class="metric-table" id="jobHistoryTable"></table>
      </div>
      <div id="jobTotals" class="subtle" style="margin-top:10px;"></div>
    </details>

    <details id="jobsListDetails" style="margin-top:10px;">
      <summary>–ü–æ–∫–∞–∑–∞—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ jobs</summary>
      <div style="margin-top:12px; overflow:auto;">
        <table class="metric-table" id="jobsListTable"></table>
      </div>
      <div class="subtle" style="margin-top:10px;">
        –ö–ª–∏–∫ –ø–æ —Å—Ç—Ä–æ–∫–µ –æ—Ç–∫—Ä–æ–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω—É—é job –≤ —ç—Ç–æ–º –∂–µ UI.
      </div>
    </details>
  </div>

  <div id="transcript-section" class="section" style="display:none;">
    <h3><span>üìù</span> –†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞</h3>
    <pre id="transcript"></pre>
  </div>

  <div id="metrics-section" class="section" style="display:none;">
    <h3><span>üìä</span> –ú–µ—Ç—Ä–∏–∫–∏ –∑–∞–ø—Ä–æ—Å–∞</h3>
    <table class="metric-table" id="metrics-table"></table>
  </div>
</div>

<script>
  const MAX_SIZE_BYTES = 1000 * 1024 * 1024;

  const videoFile     = document.getElementById('videoFile');
  const uploadButton  = document.getElementById('uploadButton');
  const spinner       = document.getElementById('spinner');
  const loaderText    = document.getElementById('loaderText');

  const transcriptSection = document.getElementById('transcript-section');
  const transcriptDiv     = document.getElementById('transcript');

  const metricsSection = document.getElementById('metrics-section');
  const metricsTable   = document.getElementById('metrics-table');

  const fileInfoEl     = document.getElementById('fileInfo');
  const fileNameEl     = document.getElementById('fileName');
  const fileSizeEl     = document.getElementById('fileSize');
  const fileDurationEl = document.getElementById('fileDuration');

  const jobStatusPanel   = document.getElementById('jobStatusPanel');
  const jobBadge         = document.getElementById('jobBadge');
  const jobIdText        = document.getElementById('jobIdText');
  const jobStageText     = document.getElementById('jobStageText');
  const jobProgressBar   = document.getElementById('jobProgressBar');
  const copyJobIdBtn     = document.getElementById('copyJobIdBtn');

  const jobHistoryPanel  = document.getElementById('jobHistoryPanel');
  const jobHistoryTable  = document.getElementById('jobHistoryTable');
  const jobTotals        = document.getElementById('jobTotals');
  const jobsListTable    = document.getElementById('jobsListTable');

  let pollTimer = null;
  let activeJobId = null;
  let selectedFileDurationSec = null;

  // ======= IP –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (user_id) =======
  let clientIp = null;
  (async () => {
    try {
      const resp = await fetch('https://api.ipify.org?format=json');
      if (resp.ok) {
        const data = await resp.json();
        clientIp = data.ip;
      }
    } catch {}
  })();

  if (copyJobIdBtn) {
    copyJobIdBtn.addEventListener('click', async () => {
      try {
        await navigator.clipboard.writeText(activeJobId || '');
        copyJobIdBtn.textContent = '–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ';
        setTimeout(() => (copyJobIdBtn.textContent = '–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å'), 1200);
      } catch {}
    });
  }

  function formatBytes(bytes) {
    if (!bytes && bytes !== 0) return '‚Äî';
    const mb = bytes / (1024 * 1024);
    if (mb < 1) return (bytes / 1024).toFixed(1) + ' –ö–ë';
    if (mb > 1024) return (mb / 1024).toFixed(2) + ' –ì–ë';
    return mb.toFixed(1) + ' –ú–ë';
  }

  function formatDuration(seconds) {
    if (seconds == null || !isFinite(seconds)) return '‚Äî';
    const total = Math.round(seconds);
    const h = Math.floor(total / 3600);
    const m = Math.floor((total % 3600) / 60);
    const s = total % 60;
    if (h > 0) return `${h}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
    return `${m}:${String(s).padStart(2,'0')}`;
  }

  function parseIsoTs(ts) {
    const d = new Date(ts);
    return isNaN(d.getTime()) ? null : d;
  }

  function fmtTime(d) {
    if (!d) return '‚Äî';
    return d.toLocaleString('ru-RU', { hour12:false });
  }

  function fmtMs(ms) {
    if (ms == null || !isFinite(ms)) return '‚Äî';
    if (ms < 1000) return `${Math.round(ms)} ms`;
    return `${(ms/1000).toFixed(2)} s`;
  }

  function resetFileInfo() {
    fileInfoEl.classList.add('empty');
    fileInfoEl.classList.remove('file-error');
    fileNameEl.textContent = '–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω';
    fileSizeEl.textContent = '–†–∞–∑–º–µ—Ä: ‚Äî';
    fileDurationEl.textContent = '–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: ‚Äî';
    selectedFileDurationSec = null;
    uploadButton.disabled = false;
  }

  function setJobUIVisible(visible) {
    jobStatusPanel.style.display = visible ? 'block' : 'none';
    jobHistoryPanel.style.display = visible ? 'block' : 'none';
  }

  function setBadge(status) {
    jobBadge.className = 'job-badge ' + (
      status === 'queued' ? 'job-queued' :
      status === 'processing' ? 'job-processing' :
      status === 'done' ? 'job-done' :
      status === 'error' ? 'job-error' : 'job-idle'
    );

    jobBadge.textContent = (
      status === 'queued' ? '–í –æ—á–µ—Ä–µ–¥–∏' :
      status === 'processing' ? '–í —Ä–∞–±–æ—Ç–µ' :
      status === 'done' ? '–ì–æ—Ç–æ–≤–æ' :
      status === 'error' ? '–û—à–∏–±–∫–∞' : '‚Äî'
    );
  }

  function setProgress(pct) {
    const v = Math.max(0, Math.min(100, Number(pct || 0)));
    jobProgressBar.style.width = v + '%';
  }

  function humanStage(step) {
    const map = {
      upload: '–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞‚Ä¶',
      queued: '–û–∂–∏–¥–∞–µ–º —Å–≤–æ–±–æ–¥–Ω—ã–π –≤–æ—Ä–∫–µ—Ä‚Ä¶',
      extract_audio: '–ò–∑–≤–ª–µ–∫–∞–µ–º –∞—É–¥–∏–æ (FFmpeg)‚Ä¶',
      transcribe: '–†–∞—Å–ø–æ–∑–Ω–∞—ë–º —Ä–µ—á—å (STT)‚Ä¶',
      finalize: '–§–∏–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç‚Ä¶',
      done: '–ì–æ—Ç–æ–≤–æ',
      error: '–û—à–∏–±–∫–∞'
    };
    return map[step] || step || '';
  }

  function stopPolling() {
    if (pollTimer) clearInterval(pollTimer);
    pollTimer = null;
  }

  // ===== –ò—Å—Ç–æ—Ä–∏—è —ç—Ç–∞–ø–æ–≤ (events) =====
  function renderHistory(events) {
    if (!Array.isArray(events) || events.length === 0) {
      jobHistoryTable.innerHTML = `
        <tr><td class="metric-label">–ò—Å—Ç–æ—Ä–∏—è</td><td>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>
      `;
      jobTotals.textContent = '';
      return;
    }

    const sorted = [...events].sort((a,b) => {
      const ta = parseIsoTs(a.ts_utc)?.getTime() ?? 0;
      const tb = parseIsoTs(b.ts_utc)?.getTime() ?? 0;
      return ta - tb;
    });

    // –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —ç—Ç–∞–ø–∞: START -> DONE (–ø–æ step)
    const starts = new Map();
    const rows = [];

    let jobStart = null;
    let jobEnd = null;

    for (const ev of sorted) {
      const d = parseIsoTs(ev.ts_utc);
      if (!jobStart && d) jobStart = d;

      const step = String(ev.step || 'unknown');
      const status = String(ev.status || '');
      const message = ev.message ? String(ev.message) : '';

      let deltaMs = null;
      if (status === 'START' && d) {
        starts.set(step, d);
      }
      if (status === 'DONE' && d) {
        const st = starts.get(step);
        if (st) deltaMs = d.getTime() - st.getTime();
        jobEnd = d;
      }
      if ((status === 'ERROR' || status === 'DONE') && d) {
        jobEnd = d;
      }

      rows.push({ step, status, time: d, deltaMs, message });
    }

    jobHistoryTable.innerHTML = `
      <tr>
        <td class="metric-label">–≠—Ç–∞–ø</td>
        <td class="metric-label">–°—Ç–∞—Ç—É—Å</td>
        <td class="metric-label">–í—Ä–µ–º—è</td>
        <td class="metric-label">–í—Ä–µ–º—è —ç—Ç–∞–ø–∞</td>
      </tr>
      ${rows.map(r => `
        <tr>
          <td>${humanStage(r.step) || r.step}</td>
          <td><span class="pill">${r.status}</span></td>
          <td>${fmtTime(r.time)}</td>
          <td>${fmtMs(r.deltaMs)}</td>
        </tr>
        ${r.message ? `
          <tr>
            <td colspan="4" class="subtle" style="padding-top:0;">${r.message}</td>
          </tr>
        ` : ``}
      `).join('')}
    `;

    const totalMs = (jobStart && jobEnd) ? (jobEnd.getTime() - jobStart.getTime()) : null;
    jobTotals.textContent = totalMs != null ? `–û–±—â–µ–µ –≤—Ä–µ–º—è job: ${fmtMs(totalMs)}` : '';
  }

  // ===== –°–ø–∏—Å–æ–∫ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö jobs =====
  async function refreshJobsList(limit = 20) {
    try {
      const resp = await fetch(`/api/v1/jobs?limit=${encodeURIComponent(limit)}`);
      if (!resp.ok) return;
      const data = await resp.json();
      const items = Array.isArray(data.items) ? data.items : [];

      jobsListTable.innerHTML = `
        <tr>
          <td class="metric-label">Job ID</td>
          <td class="metric-label">–°—Ç–∞—Ç—É—Å</td>
          <td class="metric-label">–°–æ–∑–¥–∞–Ω–æ</td>
          <td class="metric-label">–û–±–Ω–æ–≤–ª–µ–Ω–æ</td>
        </tr>
        ${items.map(j => `
          <tr class="click-row" data-jobid="${j.job_id}">
            <td style="font-family: ui-monospace, SFMono-Regular, Menlo, monospace; font-size:0.85rem;">${j.job_id}</td>
            <td><span class="pill">${j.status}</span></td>
            <td>${j.created_at ? fmtTime(parseIsoTs(j.created_at)) : '‚Äî'}</td>
            <td>${j.updated_at ? fmtTime(parseIsoTs(j.updated_at)) : '‚Äî'}</td>
          </tr>
        `).join('')}
      `;

      // click handler
      jobsListTable.querySelectorAll('tr[data-jobid]').forEach(tr => {
        tr.addEventListener('click', async () => {
          const id = tr.getAttribute('data-jobid');
          if (id) {
            activeJobId = id;
            jobIdText.textContent = id;
            await pollJob(id, { oneShot: true }); // —Ä–∞–∑–æ–≤–æ –æ–±–Ω–æ–≤–∏—Ç—å
          }
        });
      });
    } catch {}
  }

  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–∞ + –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
  videoFile.addEventListener('change', () => {
    if (!videoFile.files.length) {
      resetFileInfo();
      return;
    }

    const file = videoFile.files[0];

    fileInfoEl.classList.remove('empty');
    fileNameEl.textContent = file.name || '–ë–µ–∑ –∏–º–µ–Ω–∏';
    fileSizeEl.textContent = '–†–∞–∑–º–µ—Ä: ' + formatBytes(file.size);
    fileDurationEl.textContent = '–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: ‚Äî';
    selectedFileDurationSec = null;

    if (file.size > MAX_SIZE_BYTES) {
      fileInfoEl.classList.add('file-error');
      uploadButton.disabled = true;
      alert('–§–∞–π–ª –ø—Ä–µ–≤—ã—à–∞–µ—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä 1000 –ú–ë. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥–æ–π —Ñ–∞–π–ª.');
    } else {
      fileInfoEl.classList.remove('file-error');
      uploadButton.disabled = false;
    }

    try {
      const url = URL.createObjectURL(file);
      const tempVideo = document.createElement('video');
      tempVideo.preload = 'metadata';
      tempVideo.src = url;
      tempVideo.onloadedmetadata = () => {
        URL.revokeObjectURL(url);
        selectedFileDurationSec = tempVideo.duration;
        fileDurationEl.textContent = '–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: ' + formatDuration(tempVideo.duration);
      };
      tempVideo.onerror = () => URL.revokeObjectURL(url);
    } catch {}
  });

  function createJobWithUploadProgress(formData) {
    return new Promise((resolve, reject) => {
      const xhr = new XMLHttpRequest();
      xhr.open('POST', '/api/v1/jobs', true);

      xhr.upload.onprogress = (e) => {
        if (e.lengthComputable) {
          const pctUpload = Math.round((e.loaded / e.total) * 100);
          const uiPct = Math.round((pctUpload / 100) * 20); // 0..20%
          setProgress(uiPct);
          jobStageText.textContent = `–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞‚Ä¶ ${pctUpload}%`;
        }
      };

      xhr.onload = () => {
        if (xhr.status >= 200 && xhr.status < 300) {
          try {
            resolve(JSON.parse(xhr.responseText));
          } catch {
            reject(new Error('–°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –Ω–µ JSON'));
          }
        } else {
          reject(new Error(`–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è job: HTTP ${xhr.status} ${xhr.responseText || ''}`));
        }
      };

      xhr.onerror = () => reject(new Error('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ'));
      xhr.send(formData);
    });
  }

  async function pollJob(jobId, opts = {}) {
    const oneShot = !!opts.oneShot;

    if (!oneShot) stopPolling();

    const tick = async () => {
      try {
        const resp = await fetch(`/api/v1/jobs/${jobId}`, { method: 'GET' });
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        const data = await resp.json();

        const status = String(data.status || '').toLowerCase();
        const step = data.step ? String(data.step) : null;

        setBadge(status);

        if (typeof data.progress === 'number') setProgress(data.progress);
        else {
          if (status === 'queued') setProgress(25);
          if (status === 'processing') setProgress(60);
          if (status === 'done') setProgress(100);
          if (status === 'error') setProgress(100);
        }

        jobStageText.textContent = humanStage(step) || humanStage(status) || '‚Äî';
        renderHistory(data.events);
        refreshJobsList(20);

        if (status === 'done') {
          if (!oneShot) stopPolling();

          const result = data.result || {};
          transcriptDiv.textContent = result.transcript || '(–ø—É—Å—Ç–æ)';
          transcriptSection.style.display = 'block';

          const durationTextServer = typeof result.duration_sec === 'number'
            ? formatDuration(result.duration_sec)
            : '‚Äî';

          const durationTextClient = selectedFileDurationSec != null
            ? formatDuration(selectedFileDurationSec)
            : '‚Äî';

          metricsTable.innerHTML = `
            <tr><td class="metric-label">–Ø–∑—ã–∫</td><td>${result.language || '‚Äî'}</td></tr>
            <tr><td class="metric-label">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (–ø–æ —Ñ–∞–π–ª—É)</td><td>${durationTextClient}</td></tr>
            <tr><td class="metric-label">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (–ø–æ —Å–µ—Ä–≤–µ—Ä—É)</td><td>${durationTextServer}</td></tr>
            <tr><td class="metric-label">Job ID</td><td>${jobId}</td></tr>
          `;
          metricsSection.style.display = 'block';

          spinner.style.display = 'none';
          loaderText.style.display = 'none';
          uploadButton.disabled = false;
        }

        if (status === 'error') {
          if (!oneShot) stopPolling();
          spinner.style.display = 'none';
          loaderText.style.display = 'none';
          uploadButton.disabled = false;
          alert('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ job: ' + (data.error || 'unknown'));
        }
      } catch {
        jobStageText.textContent = '–ü—Ä–æ–±–ª–µ–º–∞ —Å–≤—è–∑–∏‚Ä¶ –ø–æ–≤—Ç–æ—Ä—è–µ–º';
      }
    };

    await tick();
    if (!oneShot) pollTimer = setInterval(tick, 1200);
  }

  uploadButton.addEventListener('click', async () => {
    stopPolling();

    if (!videoFile.files.length) {
      alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª.');
      return;
    }

    const file = videoFile.files[0];
    if (file.size > MAX_SIZE_BYTES) {
      alert('–§–∞–π–ª –ø—Ä–µ–≤—ã—à–∞–µ—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä 1000 –ú–ë. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥–æ–π —Ñ–∞–π–ª.');
      return;
    }

    transcriptSection.style.display = 'none';
    metricsSection.style.display = 'none';

    spinner.style.display = 'inline-block';
    loaderText.style.display = 'inline';
    uploadButton.disabled = true;

    setJobUIVisible(true);
    setBadge('queued');
    setProgress(1);
    jobStageText.textContent = '–ì–æ—Ç–æ–≤–∏–º –∑–∞–≥—Ä—É–∑–∫—É‚Ä¶';

    const formData = new FormData();
    formData.append('file', file);

    // backend –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —ç—Ç–∏ –ø–æ–ª—è
    formData.append('stt_provider', 'whisper');
    formData.append('channel', 'web_vr_test');
    if (clientIp) formData.append('user_id', clientIp);

    try {
      jobStageText.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞‚Ä¶';
      const jobResp = await createJobWithUploadProgress(formData);

      const jobId = (jobResp.job_id || jobResp.id || '').toString();
      if (!jobId) throw new Error('–°–µ—Ä–≤–µ—Ä –Ω–µ –≤–µ—Ä–Ω—É–ª job_id');

      activeJobId = jobId;
      jobIdText.textContent = jobId;

      if (copyJobIdBtn) {
        copyJobIdBtn.style.display = 'inline-block';
      }

      setProgress(25);
      jobStageText.textContent = '–ó–∞–¥–∞—á–∞ —Å–æ–∑–¥–∞–Ω–∞. –û–∂–∏–¥–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É‚Ä¶';

      await pollJob(jobId);
    } catch (err) {
      spinner.style.display = 'none';
      loaderText.style.display = 'none';
      uploadButton.disabled = false;
      alert(err?.message || String(err));
    }
  });

  // initial: list jobs
  refreshJobsList(20);
</script>
</body>
</html>
