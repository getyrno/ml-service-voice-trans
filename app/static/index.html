<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice Recognition</title>

    <style>
        /* === –ì–ª–æ–±–∞–ª—å–Ω—ã–π —Å—Ç–∏–ª—å –≤ –¥—É—Ö–µ Apple === */
        :root {
            color-scheme: light;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 24px 16px;
            min-height: 100vh;
            background:
                radial-gradient(circle at top left, #e8ecff 0, transparent 55%),
                radial-gradient(circle at bottom right, #ffe9f0 0, transparent 55%),
                #f5f5f7;
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "SF Pro Text",
                         "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            width: 100%;
            max-width: 720px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(26px);
            -webkit-backdrop-filter: blur(26px);
            padding: 28px 22px 26px;
            border-radius: 24px;
            box-shadow:
                0 24px 45px rgba(0, 0, 0, 0.14),
                0 0 0 0.5px rgba(0, 0, 0, 0.04);
            animation: fadeIn 0.25s ease-out;
        }

        @media (min-width: 768px) {
            .container {
                padding: 32px 32px 30px;
                border-radius: 26px;
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px) scale(0.99); }
            to   { opacity: 1; transform: translateY(0) scale(1); }
        }

        header {
            text-align: left;
            margin-bottom: 22px;
        }

        header h1 {
            margin: 0 0 4px;
            font-weight: 650;
            color: #1d1d1f;
            letter-spacing: -0.4px;
            font-size: 1.7rem;
        }

        header p {
            margin: 0;
            color: #6e6e73;
            font-size: 0.95rem;
        }

        @media (min-width: 768px) {
            header h1 {
                font-size: 1.9rem;
            }
            header p {
                font-size: 1rem;
            }
        }

        /* === –ö–∞—Ä—Ç–æ—á–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ === */
        .card {
            background: #fbfbfd;
            border-radius: 18px;
            border: 1px solid #e5e5ea;
            padding: 16px 16px 18px;
        }

        @media (min-width: 768px) {
            .card {
                padding: 18px 20px 20px;
                display: flex;
                gap: 16px;
                align-items: center;
            }
        }

        .file-area {
            flex: 1;
        }

        .file-label {
            display: block;
            margin-bottom: 6px;
            font-size: 0.9rem;
            font-weight: 500;
            color: #3a3a3c;
        }

        .file-hint {
            margin-top: 6px;
            font-size: 0.8rem;
            color: #8e8e93;
        }

        .file-hint strong {
            font-weight: 600;
            color: #1d1d1f;
        }

        input[type="file"] {
            width: 100%;
            padding: 10px 11px;
            background: #ffffff;
            border: 1px solid #d2d2d7;
            border-radius: 12px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: 0.2s;
        }

        input[type="file"]:hover {
            background: #f4f4f6;
            border-color: #b7b7c4;
        }

        /* === –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ñ–∞–π–ª–µ === */
        .file-info {
            margin-top: 10px;
            padding: 10px 11px;
            border-radius: 11px;
            background: #f5f5f7;
            border: 1px solid transparent;
            font-size: 0.85rem;
        }

        .file-info.empty {
            opacity: 0.7;
        }

        .file-info.file-error {
            border-color: #ff3b30;
            background: #fff5f5;
        }

        .file-name {
            font-weight: 500;
            color: #1d1d1f;
            margin-bottom: 3px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .file-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            color: #8e8e93;
        }

        .file-meta span {
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .dot {
            width: 4px;
            height: 4px;
            border-radius: 50%;
            background: #c7c7cc;
        }

        /* === –ö–Ω–æ–ø–∫–∞ === */
        .actions {
            margin-top: 14px;
        }

        @media (min-width: 768px) {
            .actions {
                margin-top: 0;
                width: 210px;
                text-align: right;
            }
        }

        button {
            width: 100%;
            padding: 12px 14px;
            font-size: 0.95rem;
            border: none;
            border-radius: 999px;
            cursor: pointer;
            font-weight: 600;
            color: #ffffff;
            background: linear-gradient(135deg, #0071e3, #0f8fff);
            box-shadow: 0 8px 16px rgba(0, 122, 255, 0.35);
            transition:
                background 0.2s ease,
                box-shadow 0.17s ease,
                transform 0.12s ease;
        }

        button:hover:not(:disabled) {
            background: linear-gradient(135deg, #007aff, #2f9bff);
            box-shadow: 0 11px 20px rgba(0, 122, 255, 0.45);
        }

        button:active:not(:disabled) {
            transform: translateY(1px) scale(0.99);
            box-shadow: 0 5px 12px rgba(0, 122, 255, 0.25);
        }

        button:disabled {
            background: #c7c7cc;
            box-shadow: none;
            cursor: default;
        }

        /* === –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ === */
        .loader-wrap {
            margin-top: 18px;
            display: flex;
            align-items: center;
            gap: 10px;
            min-height: 24px;
            font-size: 0.85rem;
            color: #8e8e93;
        }

        #spinner {
            display: none;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            border: 3px solid rgba(0, 0, 0, 0.07);
            border-top-color: #007aff;
            animation: spin 0.7s linear infinite;
        }

        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* === –°–µ–∫—Ü–∏–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ === */
        .section {
            margin-top: 20px;
            padding: 18px 16px 17px;
            background: #ffffff;
            border-radius: 16px;
            border: 1px solid #e5e5ea;
        }

        @media (min-width: 768px) {
            .section {
                padding: 20px 20px 18px;
            }
        }

        .section h3 {
            margin: 0 0 10px;
            font-weight: 600;
            color: #1d1d1f;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.98rem;
        }

        .section h3 span {
            font-size: 1.1rem;
        }

        .metric-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 8px;
            font-size: 0.9rem;
        }

        .metric-table td {
            padding: 7px 0;
            border-bottom: 1px solid #f1f1f3;
        }

        .metric-table tr:last-child td {
            border-bottom: none;
        }

        .metric-label {
            font-weight: 500;
            width: 40%;
            color: #3a3a3c;
        }

        pre {
            margin: 0;
            white-space: pre-wrap;
            word-wrap: break-word;
            background: #f5f5f7;
            padding: 12px 12px;
            border-radius: 12px;
            font-size: 0.9rem;
            line-height: 1.45;
            max-height: 320px;
            overflow: auto;
        }

        @media (min-width: 768px) {
            pre {
                max-height: 420px;
            }
        }

        /* –ú–µ–ª–∫–∏–µ –ø—Ä–∞–≤–∫–∏ –¥–ª—è –æ—á–µ–Ω—å –º–∞–ª–µ–Ω—å–∫–∏—Ö —ç–∫—Ä–∞–Ω–æ–≤ */
        @media (max-width: 360px) {
            header h1 {
                font-size: 1.4rem;
            }
            .container {
                padding: 20px 16px 18px;
            }
        }
    </style>
</head>

<body>
<div class="container">
    <header>
        <h1>Voice Recognition</h1>
        <p>–ó–∞–≥—Ä—É–∑–∏—Ç–µ –≤–∏–¥–µ–æ—Ñ–∞–π–ª, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –±—ã—Å—Ç—Ä—ã–π –∏ —Ç–æ—á–Ω—ã–π —Ç–µ–∫—Å—Ç.</p>
    </header>

    <div class="card">
        <div class="file-area">
            <label class="file-label" for="videoFile">–í–∏–¥–µ–æ –¥–ª—è —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏–∏</label>
            <input type="file" id="videoFile" accept="video/*">

            <div id="fileInfo" class="file-info empty">
                <div id="fileName" class="file-name">–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω</div>
                <div class="file-meta">
                    <span id="fileSize">–†–∞–∑–º–µ—Ä: ‚Äî</span>
                    <span class="dot"></span>
                    <span id="fileDuration">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: ‚Äî</span>
                </div>
            </div>

            <div class="file-hint">
                –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ ‚Äî <strong>500&nbsp;–ú–ë</strong>.  
                –î–ª—è –Ω–∞–∏–ª—É—á—à–µ–≥–æ –∫–∞—á–µ—Å—Ç–≤–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤–∏–¥–µ–æ —Å —á—ë—Ç–∫–∏–º –∑–≤—É–∫–æ–º.
            </div>
        </div>

        <div class="actions">
            <button id="uploadButton">–¢—Ä–∞–Ω—Å–∫—Ä–∏–±–∏—Ä–æ–≤–∞—Ç—å</button>
        </div>
    </div>

    <div class="loader-wrap">
        <div id="spinner"></div>
        <div id="loaderText" style="display:none;">–ò–¥—ë—Ç —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏—è‚Ä¶</div>
    </div>

    <div id="transcript-section" class="section" style="display: none;">
        <h3><span>üìù</span> –†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞</h3>
        <pre id="transcript"></pre>
    </div>

    <div id="metrics-section" class="section" style="display: none;">
        <h3><span>üìä</span> –ú–µ—Ç—Ä–∏–∫–∏ –∑–∞–ø—Ä–æ—Å–∞</h3>
        <table class="metric-table" id="metrics-table"></table>
    </div>
</div>

<script>
    const videoFile     = document.getElementById('videoFile');
    const uploadButton  = document.getElementById('uploadButton');
    const spinner       = document.getElementById('spinner');
    const loaderText    = document.getElementById('loaderText');

    const transcriptSection = document.getElementById('transcript-section');
    const transcriptDiv     = document.getElementById('transcript');

    const metricsSection = document.getElementById('metrics-section');
    const metricsTable   = document.getElementById('metrics-table');

    const fileInfoEl     = document.getElementById('fileInfo');
    const fileNameEl     = document.getElementById('fileName');
    const fileSizeEl     = document.getElementById('fileSize');
    const fileDurationEl = document.getElementById('fileDuration');

    const MAX_SIZE_BYTES = 500 * 1024 * 1024; // 500 MB
    let selectedFileDurationSec = null;

    function formatBytes(bytes) {
        if (!bytes && bytes !== 0) return '‚Äî';
        const mb = bytes / (1024 * 1024);
        if (mb < 1) {
            const kb = bytes / 1024;
            return kb.toFixed(1) + ' –ö–ë';
        }
        if (mb > 1024) {
            const gb = mb / 1024;
            return gb.toFixed(2) + ' –ì–ë';
        }
        return mb.toFixed(1) + ' –ú–ë';
    }

    function formatDuration(seconds) {
        if (seconds == null || !isFinite(seconds)) return '‚Äî';
        const total = Math.round(seconds);
        const h = Math.floor(total / 3600);
        const m = Math.floor((total % 3600) / 60);
        const s = total % 60;

        if (h > 0) {
            return `${h}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
        }
        return `${m}:${String(s).padStart(2, '0')}`;
    }

    function resetFileInfo() {
        fileInfoEl.classList.add('empty');
        fileInfoEl.classList.remove('file-error');
        fileNameEl.textContent     = '–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω';
        fileSizeEl.textContent     = '–†–∞–∑–º–µ—Ä: ‚Äî';
        fileDurationEl.textContent = '–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: ‚Äî';
        selectedFileDurationSec    = null;
        uploadButton.disabled      = false;
    }

    // === –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ñ–∞–π–ª–µ –∏ –ø–æ–ª—É—á–µ–Ω–∏–µ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ ===
    videoFile.addEventListener('change', () => {
        if (!videoFile.files.length) {
            resetFileInfo();
            return;
        }

        const file = videoFile.files[0];

        fileInfoEl.classList.remove('empty');
        fileNameEl.textContent = file.name || '–ë–µ–∑ –∏–º–µ–Ω–∏';
        fileSizeEl.textContent = '–†–∞–∑–º–µ—Ä: ' + formatBytes(file.size);
        fileDurationEl.textContent = '–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: ‚Äî';
        selectedFileDurationSec = null;

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–∏–º–∏—Ç 500 –ú–ë
        if (file.size > MAX_SIZE_BYTES) {
            fileInfoEl.classList.add('file-error');
            uploadButton.disabled = true;
            alert('–§–∞–π–ª –ø—Ä–µ–≤—ã—à–∞–µ—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä 500 –ú–ë. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥–æ–π —Ñ–∞–π–ª.');
        } else {
            fileInfoEl.classList.remove('file-error');
            uploadButton.disabled = false;
        }

        // –°—á–∏—Ç—ã–≤–∞–µ–º –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —á–µ—Ä–µ–∑ –≤—Ä–µ–º–µ–Ω–Ω—ã–π video-—ç–ª–µ–º–µ–Ω—Ç
        try {
            const url = URL.createObjectURL(file);
            const tempVideo = document.createElement('video');
            tempVideo.preload = 'metadata';
            tempVideo.src = url;

            tempVideo.onloadedmetadata = () => {
                URL.revokeObjectURL(url);
                selectedFileDurationSec = tempVideo.duration;
                fileDurationEl.textContent = '–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: ' + formatDuration(tempVideo.duration);
            };

            tempVideo.onerror = () => {
                URL.revokeObjectURL(url);
                // –û—Å—Ç–∞–≤–ª—è–µ–º –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å "‚Äî"
            };
        } catch (e) {
            // –ú–æ–ª—á–∞ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º, –±–µ–∑ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
        }
    });

    // === –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–∞–π–ª–∞ –∏ —Ä–∞—Å—á—ë—Ç –≤—Ä–µ–º–µ–Ω–∏ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–æ —Å–µ—Ä–≤–∏—Å–∞ ===
    uploadButton.addEventListener('click', async () => {
        if (!videoFile.files.length) {
            alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª.');
            return;
        }

        const file = videoFile.files[0];

        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞—â–∏—Ç–∞ –æ—Ç –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤
        if (file.size > MAX_SIZE_BYTES) {
            alert('–§–∞–π–ª –ø—Ä–µ–≤—ã—à–∞–µ—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä 500 –ú–ë. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥–æ–π —Ñ–∞–π–ª.');
            return;
        }

        const formData = new FormData();
        formData.append('file', file);

        spinner.style.display = 'inline-block';
        loaderText.style.display = 'inline';
        uploadButton.disabled = true;

        transcriptSection.style.display = 'none';
        metricsSection.style.display    = 'none';

        // –º–µ—Ç–∫–∞ –∫–ª–∏–µ–Ω—Ç–∞ ‚Äî –Ω–∞—á–∞–ª–æ –∑–∞–ø—Ä–æ—Å–∞
        const tClientStart = performance.now();
        let tClientEnd;

        try {
            const response = await fetch('/api/v1/transcribe', {
                method: 'POST',
                body: formData,
            });
            // –º–µ—Ç–∫–∞ –∫–ª–∏–µ–Ω—Ç–∞ ‚Äî –æ—Ç–≤–µ—Ç –ø–æ–ª—É—á–µ–Ω
            tClientEnd = performance.now();

            const rawText = await response.text();
            let data;

            try {
                data = JSON.parse(rawText);
            } catch {
                alert("–°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –Ω–µ JSON:\n" + rawText);
                return;
            }

            if (!response.ok) {
                const msg = data.detail || data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
                alert("–û—à–∏–±–∫–∞: " + msg);
                return;
            }

            // === –†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞ ===
            transcriptDiv.textContent = data.transcript || "(–ø—É—Å—Ç–æ)";
            transcriptSection.style.display = 'block';

            // === –†–∞—Å—á—ë—Ç –≤—Ä–µ–º–µ–Ω–∏ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–æ —Å–µ—Ä–≤–∏—Å–∞ ===
            let uploadSecondsText = '‚Äî';
            if (typeof tClientEnd === 'number' && typeof data.processing_time === 'number') {
                const clientTotalMs = tClientEnd - tClientStart;  // –≤–µ—Å—å —Ü–∏–∫–ª –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ
                const processingMs  = data.processing_time * 1000; // —Å–µ—Ä–≤–µ—Ä–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞
                const uploadMs      = Math.max(0, clientTotalMs - processingMs); // –ø—Ä–∏–º–µ—Ä–Ω–æ upload + —Å–µ—Ç–µ–≤—ã–µ –∑–∞–¥–µ—Ä–∂–∫–∏

                uploadSecondsText = (uploadMs / 1000).toFixed(3) + ' —Å–µ–∫';
            }

            // === –ú–µ—Ç—Ä–∏–∫–∏ ===
            const serverDurationSec = typeof data.duration_sec === 'number'
                ? data.duration_sec
                : null;

            const durationTextClient = selectedFileDurationSec != null
                ? formatDuration(selectedFileDurationSec)
                : '‚Äî';

            const durationTextServer = serverDurationSec != null
                ? formatDuration(serverDurationSec)
                : '‚Äî';

            metricsTable.innerHTML = `
                <tr>
                    <td class="metric-label">–Ø–∑—ã–∫</td>
                    <td>${data.language}</td>
                </tr>
                <tr>
                    <td class="metric-label">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (–ø–æ —Ñ–∞–π–ª—É)</td>
                    <td>${durationTextClient}</td>
                </tr>
                <tr>
                    <td class="metric-label">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (–ø–æ —Å–µ—Ä–≤–µ—Ä—É)</td>
                    <td>${durationTextServer}</td>
                </tr>
                <tr>
                    <td class="metric-label">–í—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ (–Ω–∞ —Å–µ—Ä–≤–∏—Å–µ)</td>
                    <td>${data.processing_time.toFixed(3)} —Å–µ–∫</td>
                </tr>
                <tr>
                    <td class="metric-label">–í—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–æ —Å–µ—Ä–≤–∏—Å–∞</td>
                    <td>${uploadSecondsText}</td>
                </tr>
                <tr>
                    <td class="metric-label">–†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞</td>
                    <td>${formatBytes(data.file_size)} (${data.file_size} –±–∞–π—Ç)</td>
                </tr>
                <tr>
                    <td class="metric-label">Video ID</td>
                    <td>${data.video_id}</td>
                </tr>
            `;
            metricsSection.style.display = 'block';

        } catch (err) {
            alert("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: " + err.message);
        } finally {
            spinner.style.display = 'none';
            loaderText.style.display = 'none';
            uploadButton.disabled = false;
        }
    });
</script>

</body>
</html>
